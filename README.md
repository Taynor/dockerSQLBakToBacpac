# dockerSQLBalToBacpac
Docker image and Terraform to provision an Azure Container Instance, to automate a SQL server .bak to .bacpac file. This solution requires the a copy of the SQLPackge utility, hosted in the root directory of the solution files. This is depcited below.

Architecture
Currently the solution consists of the following resources, hosted in Azure:

Docker Image
Azure Container Instance
Azure File Share
SQLPackage utility
Shell and T-SQL scripts
The container instance is designed to run with a kick off script/command, and will require no further action from the user.

The Docker Image
The below image is a screen grab of the Docker file used to create the image.

image.png

The image is based on the latest SQL server 2019 image from Microsoft. It has been packaged up with PowerShell and unzip, to future proof scenarios for an interactive container. What is key about the image is that the /var/opt/sqlserver path is created, when the Azure container instance is spun up. This path will be the access point to the Azure File Share. The image also contains the following environment variables:

SQL server default data, logs and backup paths. These are required for the automated conversion process.
The sa account password, this allows the container to manage the conversion process without user interaction.
The SQL server licensing agreement confirmation
The Shell Scripts
The key shell scripts that enable the automation of the container instance. Are used to kick child scripts, that contain the logic and dynamic values required to perform the automated conversion. Some of the logic, is used to overcome bugs within the version of Docker and a SQL server image. Others are used to pass runtime values, generated by extracted data from the database backup .bak file.

This is the entrypoint.sh script required to kick off the process, once the container starts. There is a 1 minute delay before executing the database-conversion-control-process.sh. This is to allow the container instance to fully start up the SQL server database engine service.

image.png

The database-conversion-control-process.sh script, executes the necessary shell and T-SQL scripts (wrapped in sqlcmd commands) in dependency order. The 10 second delay before executing the database-export.sh script. Is required to allow the database-cleanup-utility.sh script to release the file handle on the dbname.txt file. This file stores the value of the database name retrieved from the .bak file. Once the string manipulation in the dbname.txt file is complete, the value is copied to dbname-replace.txt file. This is necessary to replace the value of the database name in the sqlpackage export command.
The database-cleanup-utility.sh script, contains the logic to clean up the database objects within the restored database. It also performs the string manipulation in the dbname.txt file and database-export.sh script.

image.png

The database-export.sh script executes the sqlpackage export command. The Data Source is set to localhost, as the command is exporting the database from the local running SQL server instance in the container instance. The Initial Catalog=databasename is set by the logic executed in the database-cleanup-utility.sh script.

image.png

The T-SQL Logic
This is the logic contained in the T-SQL scripts, that extract the database configuration values. These include the following:

Database name
Database data file logical name
Database log file logical name
These values are used through the sqlcmd commands executing the T-SQL scripts. To create the blank database (Docker version bug dependency) and restore the database using the .bak file.

image.png
